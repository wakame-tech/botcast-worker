services:
  voicevox_engine:
    image: voicevox/voicevox_engine:nvidia-ubuntu20.04-latest
    ports:
      - "50021:50021"
    tty: true
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
  jaeger:
    image: "jaegertracing/all-in-one:latest"
    ports:
      - "5000:5000" # gRPC server
      - "16686:16686" # Web UI
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    command:
      - "--collector.otlp.grpc.host-port=5000"
  otel-collector:
    image: otel/opentelemetry-collector:latest
    restart: always
    command: ["--config=/etc/otel-collector-config.yaml", ""]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"
    depends_on:
      - jaeger
  rust:
    build:
      context: .
      args:
        - DATABASE_URL=${DATABASE_URL}
    working_dir: /app
    ports:
      - "9001:9001"
    environment:
      - PORT=9001
      - KEEP_WORKDIR=${KEEP_WORKDIR}
      - VOICEVOX_ENDPOINT=${VOICEVOX_ENDPOINT}
      - CLOUDFLARE_ACCOUNT_ID=${CLOUDFLARE_ACCOUNT_ID}
      - DATABASE_URL=${DATABASE_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BUCKET_ENDPOINT=${BUCKET_ENDPOINT}
      - USER_AGENT=${USER_AGENT}
